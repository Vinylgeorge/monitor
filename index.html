<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üìä MTurk Earnings + User Mapping + Alerts</title>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, getDocs, orderBy, query } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCCtBCAJvQCDj8MXb2w90qYUqRrENIIGIQ",
    authDomain: "mturk-monitordeep.firebaseapp.com",
    projectId: "mturk-monitordeep",
    storageBucket: "mturk-monitordeep.firebasestorage.app",
    messagingSenderId: "58392297487",
    appId: "1:58392297487:web:1365ad12110ffd0586637a"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  let tableData = [], userMap = {};

  // üß© Fetch mapping from Google Sheet (must be published to web)
  async function loadUserMapping() {
    const csvUrl =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vTzZQXbxQBTZ2Obh8Q3i_kczKx1__hUfRkDQbaFgRZqjM9dz7oM1xR4gSPEYjbxah7XLt7J4twA9m14/pub?output=csv";
    try {
      const res = await fetch(csvUrl);
      const text = await res.text();
      const rows = text.split("\n").map(r => r.split(","));
      for (let i = 1; i < rows.length; i++) {
        const [worker, user] = rows[i].map(c => c.trim());
        if (worker && user) userMap[worker] = user;
      }
    } catch (err) {
      console.warn("‚ö†Ô∏è Could not load Google Sheet mapping:", err);
    }
  }

  // üßÆ Helper: Convert "09/09/25" ‚Üí "25-09"
  function getMonthKey(dateStr) {
    if (!dateStr) return null;
    const [mm, dd, yy] = dateStr.split("/");
    return `${yy}-${mm}`;
  }

  // üì• Load Firestore Data + Combine with Sheet mapping
  async function loadData() {
    const tableBody = document.getElementById("dataBody");
    tableBody.innerHTML = "<tr><td colspan='11'>Loading‚Ä¶</td></tr>";
    tableData = [];

    try {
      const q = query(collection(db, "earnings_logs"), orderBy("timestamp", "desc"));
      const snapshot = await getDocs(q);

      // Group totals by month
      const monthlyTransfers = {};
      snapshot.forEach(doc => {
        const d = doc.data();
        const key = getMonthKey(d.lastTransferDate);
        if (key) {
          const amt = parseFloat(d.lastTransferAmount || 0);
          monthlyTransfers[key] = (monthlyTransfers[key] || 0) + (isNaN(amt) ? 0 : amt);
        }
      });

      let html = "";
      snapshot.forEach(doc => {
        const d = doc.data();
        const monthKey = getMonthKey(d.lastTransferDate);
        const lastMonthTotal = monthKey ? (monthlyTransfers[monthKey] || 0).toFixed(2) : "0.00";
        const isAlert = d.alert && d.alert !== "OK";
        const user = userMap[d.workerId] || "‚Äî";

        const row = {
          WorkerID: d.workerId || "",
          User: user,
          CurrentEarnings: d.currentEarnings || "",
          LastTransfer: d.lastTransferAmount || "",
          LastTransferDate: d.lastTransferDate || "",
          LastMonthTotal: lastMonthTotal,
          NextTransferDate: d.nextTransferDate || "",
          BankAccount: d.bankAccount || "",
          IP: d.ip || "",
          Alert: d.alert || "OK",
          Updated: new Date(d.timestamp?.seconds * 1000 || Date.now()).toLocaleString()
        };
        tableData.push(row);

        html += `
          <tr class="${isAlert ? "alert-row" : ""}">
            <td>${row.WorkerID}</td>
            <td>${row.User}</td>
            <td>${row.IP}</td>
            <td>${row.CurrentEarnings}</td>
            <td>${row.LastTransfer}</td>
            <td>${row.LastTransferDate}</td>
            <td>${row.LastMonthTotal}</td>
            <td>${row.NextTransferDate}</td>
            <td>${row.BankAccount}</td>
            <td>${row.Alert}</td>
            <td>${row.Updated}</td>
          </tr>`;
      });

      tableBody.innerHTML = html || "<tr><td colspan='11'>No records found</td></tr>";
    } catch (err) {
      console.error("Error loading Firebase data:", err);
      tableBody.innerHTML = "<tr><td colspan='11'>Error loading data.</td></tr>";
    }
  }

  // üîç Filter table
  function filterTable() {
    const filter = document.getElementById("searchInput").value.toLowerCase();
    document.querySelectorAll("#dataBody tr").forEach(row => {
      row.style.display = row.textContent.toLowerCase().includes(filter) ? "" : "none";
    });
  }

  // üì§ Export to CSV
  function exportToCSV() {
    if (!tableData.length) return alert("No data to export.");
    const headers = Object.keys(tableData[0]);
    const csv = [headers.join(",")].concat(
      tableData.map(r => headers.map(h => `"${(r[h] || "").replace(/"/g, '""')}"`).join(","))
    ).join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `MTurk_Earnings_${new Date().toISOString().split("T")[0]}.csv`;
    link.click();
  }

  // ‚ö° Initialize
  window.addEventListener("DOMContentLoaded", async () => {
    await loadUserMapping();
    document.getElementById("refreshBtn").addEventListener("click", loadData);
    document.getElementById("searchInput").addEventListener("keyup", filterTable);
    document.getElementById("exportBtn").addEventListener("click", exportToCSV);
    loadData();
  });
</script>

<style>
body{font-family:Inter,Roboto,Arial,sans-serif;background:#f8fafc;margin:0;padding:20px;color:#111}
header{text-align:center;background:linear-gradient(135deg,#2563eb,#1e3a8a);color:white;padding:20px;border-radius:10px}
.controls{display:flex;justify-content:space-between;margin-bottom:15px;flex-wrap:wrap}
input[type=text]{padding:8px 10px;border:1px solid #ddd;border-radius:6px;width:260px;font-size:14px}
button{background:#2563eb;border:none;color:white;padding:8px 14px;border-radius:6px;cursor:pointer;margin-left:8px}
button:hover{background:#1d4ed8}
table{width:100%;border-collapse:collapse;background:white;border-radius:8px;overflow:hidden;box-shadow:0 0 6px rgba(0,0,0,.05)}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:left;font-size:14px}
th{background:#f1f5f9}
tr.alert-row{background:#fee2e2;color:#b91c1c;font-weight:600}
tr:hover{background:#f9fafb}
footer{text-align:center;margin-top:15px;font-size:12px;color:#666}
</style>
</head>

<body>
<header>
  <h1>üìä MTurk Earnings + User Mapping + Alerts</h1>
  <p>Auto-synced from Firebase ‚Äî User linked from Google Sheet</p>
</header>

<div class="controls">
  <input id="searchInput" type="text" placeholder="üîç Filter by worker, user, bank, or alert‚Ä¶">
  <div>
    <button id="refreshBtn">üîÑ Refresh</button>
    <button id="exportBtn">üì§ Export CSV</button>
  </div>
</div>

<table>
  <thead>
    <tr>
      <th>Worker ID</th><th>User</th><th>IP</th><th>Current Earnings</th>
      <th>Last Transfer ($)</th><th>Last Transfer Date</th><th>Last Month Transfer ($)</th>
      <th>Next Transfer Date</th><th>Bank</th><th>Alert</th><th>Updated</th>
    </tr>
  </thead>
  <tbody id="dataBody"><tr><td colspan="11">Loading‚Ä¶</td></tr></tbody>
</table>

<footer>¬© 2025 AB2Soft | Firebase + Google Sheet User Mapping + CSV Export</footer>
</body>
</html>
