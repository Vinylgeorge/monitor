<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>🔒 MTurk Earnings + User + Alerts (Secure)</title>
<style>
:root{--pri:#2563eb;--pri2:#1e40af;--bg:#f8fafc}
*{box-sizing:border-box}
body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);margin:0;padding:20px;color:#111}
header{background:linear-gradient(135deg,var(--pri),var(--pri2));color:#fff;padding:20px;border-radius:12px;text-align:center}
.controls{display:flex;gap:10px;justify-content:space-between;flex-wrap:wrap;margin:16px 0}
input[type=text],input[type=password]{padding:8px 10px;border:1px solid #ddd;border-radius:8px;font-size:14px;width:260px}
button{background:var(--pri);color:#fff;border:0;padding:9px 14px;border-radius:8px;cursor:pointer}
button:hover{background:var(--pri2)}
table{width:100%;border-collapse:collapse;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 1px 8px rgba(0,0,0,0.05)}
th,td{padding:10px 12px;border-bottom:1px solid #eee;text-align:left;font-size:14px}
th{background:#f1f5f9}
tr:hover{background:#f9fafb}
tr.alert-row{background:#fee2e2!important;color:#b91c1c;font-weight:600}
footer{text-align:center;margin-top:14px;font-size:12px;color:#666}
/* Password Gate */
#gate{position:fixed;inset:0;background:linear-gradient(180deg,#0f172a,#111827);display:flex;align-items:center;justify-content:center;z-index:9999}
#gate .card{width:min(420px,92vw);background:#0b1220;border:1px solid #1f2937;border-radius:14px;padding:22px;color:#dbeafe;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,.45)}
#gate h2{margin-bottom:10px;font-weight:700;color:#fff}
#gate p{color:#93c5fd;margin:0 0 10px}
#gate input{width:100%;padding:12px;border-radius:10px;border:1px solid #334155;background:#0a1222;color:#e5e7eb;outline:none;margin-bottom:10px}
#gate input:focus{border-color:#60a5fa;box-shadow:0 0 0 3px rgba(96,165,250,.25)}
#gate button{width:100%;background:#22c55e}
#gate button:hover{background:#16a34a}
#gate .msg{margin-top:8px;font-size:12px;color:#fca5a5;min-height:16px}
#app{display:none}
</style>
</head>

<body>
<!-- 🔐 Password Gate -->
<section id="gate">
  <div class="card">
    <h2>🔒 Secure Access</h2>
    <p>Enter password</p>
    <input id="pw" type="password" placeholder="••••••••••••••••" />
    <button id="unlockBtn">Unlock</button>
    <div class="msg" id="gateMsg"></div>
  </div>
</section>

<!-- 📊 Dashboard -->
<section id="app">
  <header>
    <h1>📊 MTurk Earnings + User + Alerts</h1>
    <p>Auto-synced from Firebase — grouped by month — Sheet-linked users</p>
  </header>

  <div class="controls">
    <input id="searchInput" type="text" placeholder="🔍 Search user, worker, or alert...">
    <div>
      <button id="refreshBtn">🔄 Refresh</button>
      <button id="exportBtn">📤 Export CSV</button>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Worker ID</th>
        <th>User</th>
        <th>Current Earnings ($)</th>
        <th>Last Transfer ($)</th>
        <th>Last Transfer Date</th>
        <th>Last Month Total ($)</th>
        <th>Next Transfer</th>
        <th>Bank</th>
        <th>IP</th>
        <th>Alert</th>
        <th>Updated</th>
      </tr>
    </thead>
    <tbody id="dataBody">
      <tr><td colspan="11">Loading … (waiting unlock)</td></tr>
    </tbody>
  </table>
  <footer>© 2025 AB2Soft | Firebase Earnings Dashboard + User Mapping + Alerts</footer>
</section>

<script type="module">
/* ---------- Password Logic ---------- */
const EXPECTED_HASH = "9b724d9df97a91d297dc1c714a3987338ebb60a2a53311d2e382411a78b9e07d"; // SHA256(AB2EARNINGS2025)
const gate=document.getElementById("gate"),app=document.getElementById("app"),pw=document.getElementById("pw"),btn=document.getElementById("unlockBtn"),msg=document.getElementById("gateMsg");

async function hashText(txt){
  const buf=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(txt));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}

btn.onclick=async()=>{
  msg.textContent="";
  const entered=pw.value.trim();
  if(!entered){msg.textContent="Enter password";return;}
  const h=await hashText(entered);
  if(h===EXPECTED_HASH){
    localStorage.setItem("mturkGate","ok");
    gate.style.display="none";app.style.display="block";
    initApp();
  }else msg.textContent="❌ Incorrect password";
};
pw.addEventListener("keydown",e=>{if(e.key==="Enter")btn.click();});

if(localStorage.getItem("mturkGate")==="ok"){gate.style.display="none";app.style.display="block";initApp();}

/* ---------- Firebase + Table Logic ---------- */
async function initApp(){
  const {initializeApp}=await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js");
  const {getFirestore,collection,getDocs,orderBy,query}=await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");

  const firebaseConfig={
    apiKey:"AIzaSyCCtBCAJvQCDj8MXb2w90qYUqRrENIIGIQ",
    authDomain:"mturk-monitordeep.firebaseapp.com",
    projectId:"mturk-monitordeep",
    storageBucket:"mturk-monitordeep.firebasestorage.app",
    messagingSenderId:"58392297487",
    appId:"1:58392297487:web:1365ad12110ffd0586637a"
  };
  const fbApp=initializeApp(firebaseConfig);
  const db=getFirestore(fbApp);
  const tbody=document.getElementById("dataBody");
  let rows=[];

  const monthKey=d=>{if(!d)return null;const p=String(d).split("/");return p.length===3?`${p[2]}-${p[0]}`:null;};
  const tsToLocal=ts=>{
    if(!ts)return"";try{
      if(typeof ts==="object"&&typeof ts.seconds==="number")return new Date(ts.seconds*1000).toLocaleString();
      const d=new Date(ts);if(!isNaN(d))return d.toLocaleString();
    }catch{}return String(ts);
  };

  async function loadData(){
    tbody.innerHTML="<tr><td colspan='11'>Loading…</td></tr>";
    rows=[];
    const q=query(collection(db,"earnings_logs"),orderBy("timestamp","desc"));
    const snap=await getDocs(q);
    const monthly={};
    snap.forEach(doc=>{
      const d=doc.data(),k=monthKey(d.lastTransferDate);
      if(k){const a=parseFloat(d.lastTransferAmount||0);monthly[k]=(monthly[k]||0)+(isNaN(a)?0:a);}
    });
    let html="";
    snap.forEach(doc=>{
      const d=doc.data(),k=monthKey(d.lastTransferDate),sum=k&&monthly[k]?monthly[k].toFixed(2):"0.00";
      const bad=d.alert&&d.alert!=="OK"&&d.alert!=="✅ OK";
      const r={WorkerID:d.workerId||"",User:d.user||"Unknown",Current:d.currentEarnings||"0",LastAmt:d.lastTransferAmount||"0",
        LastDate:d.lastTransferDate||"",MonthTotal:sum,NextDate:d.nextTransferDate||"",Bank:d.bankAccount||"",
        IP:d.ip||"",Alert:d.alert||"OK",Updated:tsToLocal(d.timestamp)};
      rows.push(r);
      html+=`<tr class="${bad?"alert-row":""}"><td>${r.WorkerID}</td><td>${r.User}</td><td>${r.Current}</td>
      <td>${r.LastAmt}</td><td>${r.LastDate}</td><td>${r.MonthTotal}</td><td>${r.NextDate}</td>
      <td>${r.Bank}</td><td>${r.IP}</td><td>${r.Alert}</td><td>${r.Updated}</td></tr>`;
    });
    tbody.innerHTML=html||"<tr><td colspan='11'>No records found</td></tr>";
  }

  document.getElementById("refreshBtn").onclick=loadData;
  document.getElementById("searchInput").oninput=()=>{const q=document.getElementById("searchInput").value.toLowerCase();
    document.querySelectorAll("#dataBody tr").forEach(tr=>{tr.style.display=tr.textContent.toLowerCase().includes(q)?"":"none";});
  };
  document.getElementById("exportBtn").onclick=()=>{
    if(!rows.length)return alert("No data to export");
    const H=Object.keys(rows[0]);
    const csv=[H.join(","),...rows.map(o=>H.map(h=>`"${String(o[h]||"").replace(/"/g,'""')}"`).join(","))].join("\n");
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);a.download="MTurk_Earnings.csv";a.click();
  };

  loadData();
}
</script>
</body>
</html>
