<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üîé MTurk Earnings Monitor</title>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
  getFirestore, collection, query, orderBy, onSnapshot 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// --- Firebase Config ---
const firebaseConfig = {
  apiKey: "AIzaSyCCtBCAJvQCDj8MXb2w90qYUqRrENIIGIQ",
  authDomain: "mturk-monitordeep.firebaseapp.com",
  projectId: "mturk-monitordeep",
  storageBucket: "mturk-monitordeep.firebasestorage.app",
  messagingSenderId: "58392297487",
  appId: "1:58392297487:web:1365ad12110ffd0586637a"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Utility: format number
const fmt = n => isNaN(n) ? "" : Number(n).toFixed(2);

// Global data cache
let tableData = [];

// --- CSV export function ---
function downloadCSV() {
  if (!tableData.length) return alert("No data to export!");

  const headers = [
    "Worker ID","User","Current ($)","Last Month ($)",
    "Last Transfer ($)","Last Transfer Date",
    "Next Transfer Date","Bank / Gift Card","IP","Alert","Timestamp"
  ];

  const rows = tableData.map(d => [
    d.workerId || "",
    d.user || "",
    fmt(d.currentEarnings),
    fmt(d.lastMonthEarnings),
    fmt(d.lastTransferAmount),
    d.lastTransferDate || "",
    d.nextTransferDate || "",
    d.bankAccount || "",
    d.ip || "",
    d.alert || "",
    d.timestampStr || ""
  ]);

  const csv = [headers, ...rows]
    .map(r => r.map(x => `"${String(x).replace(/"/g,'""')}"`).join(","))
    .join("\n");

  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `MTurk_Earnings_${new Date().toISOString().split("T")[0]}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// --- Real-time snapshot listener ---
onSnapshot(
  query(collection(db, "earnings_logs"), orderBy("timestamp", "desc")),
  (snap) => {
    const tbody = document.querySelector("#tableBody");
    const totalElem = document.querySelector("#totalCurrentEarnings");
    if (!tbody || !totalElem) {
      console.error("‚ùå Required elements not found");
      return;
    }

    let html = "";
    let totalCurrent = 0;
    tableData = [];

    snap.forEach(doc => {
      const d = doc.data();

      // Convert Firestore timestamp ‚Üí readable local time
      let ts = "";
      if (d.timestamp?.seconds) {
        ts = new Date(d.timestamp.seconds * 1000)
          .toLocaleString("en-US", { timeZone: "Asia/Kolkata" });
      } else if (typeof d.timestamp === "string") {
        ts = d.timestamp;
      }
      d.timestampStr = ts;

      const cur = parseFloat(d.currentEarnings) || 0;
      totalCurrent += cur;

      const isAlert = d.alert && d.alert !== "OK" && d.alert !== "‚úÖ OK";
      html += `
        <tr class="${isAlert ? "alert-row" : ""}">
          <td>${d.workerId || ""}</td>
          <td>${d.user || ""}</td>
          <td>${fmt(d.currentEarnings)}</td>
          <td>${fmt(d.lastMonthEarnings)}</td>
          <td>${fmt(d.lastTransferAmount)}</td>
          <td>${d.lastTransferDate || ""}</td>
          <td>${d.nextTransferDate || ""}</td>
          <td>${d.bankAccount || ""}</td>
          <td>${d.ip || ""}</td>
          <td>${d.alert || ""}</td>
          <td>${ts}</td>
        </tr>`;

      tableData.push(d);
    });

    totalElem.textContent = `Current Earnings This Month: $${fmt(totalCurrent)}`;
    tbody.innerHTML = html;
  }
);
</script>

<style>
body {
  font-family: "Inter", Roboto, Arial, sans-serif;
  background: #f9fafb;
  color: #111827;
  padding: 16px;
}
h1 {
  font-size: 20px;
  margin-bottom: 12px;
  color: #1f2937;
}
#totalCurrentEarnings {
  font-size: 18px;
  margin-bottom: 10px;
  font-weight: bold;
  color: #111827;
}
button {
  background: #2563eb;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
  margin-bottom: 16px;
}
button:hover { background: #1e40af; }
table {
  width: 100%;
  border-collapse: collapse;
  background: white;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  border-radius: 8px;
  overflow: hidden;
}
thead {
  background: #111827;
  color: #fff;
}
th, td {
  padding: 8px 10px;
  text-align: left;
  border-bottom: 1px solid #e5e7eb;
  font-size: 13px;
}
tr:hover { background: #f3f4f6; }
.alert-row { background: #fee2e2; color: #991b1b; font-weight: 600; }
</style>
</head>

<body>
  <h1>üìä MTurk Earnings Monitor ‚Äì Live</h1>
  <div id="totalCurrentEarnings">Current Earnings This Month: $0.00</div>
  <button onclick="downloadCSV()">‚¨áÔ∏è Download CSV</button>

  <table>
    <thead>
      <tr>
        <th>Worker ID</th>
        <th>User</th>
        <th>Current ($)</th>
        <th>Last Month ($)</th>
        <th>Last Transfer ($)</th>
        <th>Last Transfer Date</th>
        <th>Next Transfer Date</th>
        <th>Bank / Gift Card</th>
        <th>IP</th>
        <th>Alert</th>
        <th>Timestamp</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</body>
</html>
