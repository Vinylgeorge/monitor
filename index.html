// ----------------------------
// üí∞ Earnings Logs (Alert priority + timestamp sort)
// ----------------------------
let tableData = [];

onSnapshot(collection(db, "earnings_logs"), (snap) => {
  const tbody = document.querySelector("#earnings tbody");
  const totalElem = document.querySelector("#totalEarnings");
  tbody.innerHTML = "";
  tableData = [];

  snap.forEach(docSnap => {
    const d = docSnap.data();
    const rawTs = d.timestamp || d.createdAt || d.timestampStr;
    const tsStr = formatIndianTime(rawTs);
    const tsMillis = getTimestampMillis(rawTs);
    const cur = parseFloat(d.currentEarnings) || 0;

    tableData.push({
      user: d.user || "",
      workerId: d.workerId || "",
      currentEarnings: d.currentEarnings || "",
      lastMonthEarnings: d.lastMonthEarnings || "",
      lastTransferAmount: d.lastTransferAmount || "",
      lastTransferDate: d.lastTransferDate || "",
      nextTransferDate: d.nextTransferDate || "",
      bankAccount: d.bankAccount || "",
      alert: d.alert || "",
      ip: d.ip || "",
      timestamp: tsStr,
      tsMillis
    });
  });

  // 1Ô∏è‚É£ Sort so alerts always come first, then newest ‚Üí oldest
  tableData.sort((a, b) => {
    const aAlert = a.alert?.trim() ? 1 : 0;
    const bAlert = b.alert?.trim() ? 1 : 0;
    if (aAlert !== bAlert) return bAlert - aAlert; // alert rows first
    return b.tsMillis - a.tsMillis; // newest ‚Üí oldest
  });

  // 2Ô∏è‚É£ Compute total current earnings
  const total = tableData.reduce((sum, d) => sum + (parseFloat(d.currentEarnings) || 0), 0);
  totalElem.textContent = `Total Current Earnings: $${total.toFixed(2)}`;

  // 3Ô∏è‚É£ Render table
  for (const row of tableData) {
    const highlight = row.alert?.trim()
      ? "style='background:#fff5f5;color:#b91c1c;font-weight:600;'"
      : "";
    tbody.innerHTML += `
      <tr ${highlight}>
        <td>${row.user}</td>
        <td>${row.workerId}</td>
        <td>${row.currentEarnings}</td>
        <td>${row.lastMonthEarnings}</td>
        <td>${row.lastTransferAmount}</td>
        <td>${row.lastTransferDate}</td>
        <td>${row.nextTransferDate}</td>
        <td>${row.bankAccount}</td>
        <td>${row.alert}</td>
        <td>${row.ip}</td>
        <td>${row.timestamp}</td>
      </tr>`;
  }
});
