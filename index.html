<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>📊 MTurk Earnings + User + Alerts</title>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, getDocs, orderBy, query } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // 🔧 Firebase Configuration
  const firebaseConfig = {
    apiKey: "AIzaSyCCtBCAJvQCDj8MXb2w90qYUqRrENIIGIQ",
    authDomain: "mturk-monitordeep.firebaseapp.com",
    projectId: "mturk-monitordeep",
    storageBucket: "mturk-monitordeep.firebasestorage.app",
    messagingSenderId: "58392297487",
    appId: "1:58392297487:web:1365ad12110ffd0586637a"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  let tableData = [];

  // 🧮 Convert date "09/09/25" to key (for monthly grouping)
  function monthKey(dateStr) {
    if (!dateStr) return null;
    const [mm, dd, yy] = dateStr.split("/");
    return `${yy}-${mm}`;
  }

  // 📥 Load Firebase Data
  async function loadData() {
    const tbody = document.getElementById("dataBody");
    tbody.innerHTML = "<tr><td colspan='11'>Loading...</td></tr>";
    tableData = [];

    try {
      const q = query(collection(db, "earnings_logs"), orderBy("timestamp", "desc"));
      const snapshot = await getDocs(q);

      const monthlyTotals = {};
      snapshot.forEach(doc => {
        const d = doc.data();
        const key = monthKey(d.lastTransferDate);
        if (key) {
          if (!monthlyTotals[key]) monthlyTotals[key] = 0;
          const amt = parseFloat(d.lastTransferAmount || 0);
          monthlyTotals[key] += isNaN(amt) ? 0 : amt;
        }
      });

      let html = "";
      snapshot.forEach(doc => {
        const d = doc.data();
        const key = monthKey(d.lastTransferDate);
        const monthTotal = key && monthlyTotals[key] ? monthlyTotals[key].toFixed(2) : "0.00";
        const isAlert = d.alert && !d.alert.includes("OK");

        const row = {
          WorkerID: d.workerId || "",
          User: d.user || "Unknown",
          CurrentEarnings: d.currentEarnings || "0.00",
          LastTransfer: d.lastTransferAmount || "0.00",
          LastTransferDate: d.lastTransferDate || "",
          LastMonthTransfer: monthTotal,
          NextTransfer: d.nextTransferDate || "",
          Bank: d.bankAccount || "",
          IP: d.ip || "",
          Alert: d.alert || "OK",
          Updated: new Date(d.timestamp?.seconds * 1000 || Date.now()).toLocaleString()
        };
        tableData.push(row);

        html += `
          <tr class="${isAlert ? "alert-row" : ""}">
            <td>${row.WorkerID}</td>
            <td>${row.User}</td>
            <td>${row.CurrentEarnings}</td>
            <td>${row.LastTransfer}</td>
            <td>${row.LastTransferDate}</td>
            <td>${row.LastMonthTransfer}</td>
            <td>${row.NextTransfer}</td>
            <td>${row.Bank}</td>
            <td>${row.IP}</td>
            <td>${row.Alert}</td>
            <td>${row.Updated}</td>
          </tr>
        `;
      });

      tbody.innerHTML = html || "<tr><td colspan='11'>No records found</td></tr>";
    } catch (e) {
      console.error("Error loading:", e);
      tbody.innerHTML = "<tr><td colspan='11'>Error fetching data.</td></tr>";
    }
  }

  // 🔍 Filter table by text
  function filterTable() {
    const filter = document.getElementById("searchInput").value.toLowerCase();
    document.querySelectorAll("#dataBody tr").forEach(tr => {
      tr.style.display = tr.textContent.toLowerCase().includes(filter) ? "" : "none";
    });
  }

  // 📤 Export CSV
  function exportCSV() {
    if (tableData.length === 0) {
      alert("No data to export.");
      return;
    }
    const headers = Object.keys(tableData[0]);
    const rows = [headers.join(",")];
    for (const r of tableData) {
      rows.push(headers.map(h => `"${String(r[h] || "").replace(/"/g, '""')}"`).join(","));
    }
    const blob = new Blob([rows.join("\n")], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `MTurk_Earnings_${new Date().toISOString().split("T")[0]}.csv`;
    link.click();
  }

  window.addEventListener("DOMContentLoaded", () => {
    document.getElementById("refreshBtn").addEventListener("click", loadData);
    document.getElementById("searchInput").addEventListener("keyup", filterTable);
    document.getElementById("exportBtn").addEventListener("click", exportCSV);
    loadData();
  });
</script>

<style>
  body { font-family: Inter, Roboto, Arial, sans-serif; background: #f8fafc; color: #111; margin: 0; padding: 20px; }
  header { background: linear-gradient(135deg,#2563eb,#1e3a8a); color: #fff; padding: 20px; border-radius: 10px; text-align: center; }
  .controls { display:flex; justify-content:space-between; margin:20px 0; flex-wrap:wrap; }
  input[type=text] { padding:8px 10px; border:1px solid #ccc; border-radius:6px; font-size:14px; width:260px; }
  button { background:#2563eb; color:#fff; border:none; border-radius:6px; padding:8px 14px; cursor:pointer; }
  button:hover { background:#1e40af; }
  table { width:100%; border-collapse:collapse; background:#fff; border-radius:8px; overflow:hidden; box-shadow:0 1px 8px rgba(0,0,0,0.05); }
  th, td { padding:10px; border-bottom:1px solid #eee; text-align:left; font-size:14px; }
  th { background:#f1f5f9; }
  tr:hover { background:#f9fafb; }
  tr.alert-row { background:#fee2e2 !important; color:#b91c1c; font-weight:600; }
  footer { text-align:center; margin-top:15px; font-size:12px; color:#666; }
</style>
</head>

<body>
  <header>
    <h1>📊 MTurk Earnings + User + Alerts</h1>
    <p>Live from Firebase — includes Sheet-linked User field</p>
  </header>

  <div class="controls">
    <input id="searchInput" type="text" placeholder="🔍 Search by user, worker, or alert...">
    <div>
      <button id="refreshBtn">🔄 Refresh</button>
      <button id="exportBtn">📤 Export CSV</button>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Worker ID</th>
        <th>User</th>
        <th>Current Earnings ($)</th>
        <th>Last Transfer ($)</th>
        <th>Last Transfer Date</th>
        <th>Last Month Transfer ($)</th>
        <th>Next Transfer</th>
        <th>Bank</th>
        <th>IP</th>
        <th>Alert</th>
        <th>Updated</th>
      </tr>
    </thead>
    <tbody id="dataBody">
      <tr><td colspan="11">Loading data...</td></tr>
    </tbody>
  </table>

  <footer>© 2025 AB2Soft | Firebase-Synced MTurk Earnings + Alerts Dashboard</footer>
</body>
</html>
