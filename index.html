<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>📊 MTurk Earnings + Alerts + Last Month</title>
<style>
:root{--pri:#2563eb;--pri2:#1d4ed8;--bg:#f8fafc}
body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);margin:0;padding:20px;color:#111}
header{background:linear-gradient(135deg,#2563eb,#1e3a8a);color:#fff;padding:20px;border-radius:12px;text-align:center}
.controls{display:flex;gap:10px;justify-content:space-between;flex-wrap:wrap;margin:12px 0}
input[type=text]{padding:8px 10px;border:1px solid #ddd;border-radius:8px;width:260px;font-size:14px}
button{background:var(--pri);border:0;color:#fff;padding:9px 14px;border-radius:8px;cursor:pointer}
button:hover{background:var(--pri2)}
table{width:100%;border-collapse:collapse;background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 2px 16px rgba(0,0,0,.06)}
th,td{padding:10px 12px;border-bottom:1px solid #f1f5f9;text-align:left;font-size:14px}
th{background:#f1f5f9}
tr.alert-row{background:#fee2e2!important;color:#b91c1c;font-weight:600}
footer{margin-top:14px;text-align:center;color:#6b7280;font-size:12px}
#gate{position:fixed;inset:0;background:linear-gradient(180deg,#0f172a 0,#111827 100%);display:flex;align-items:center;justify-content:center;z-index:9999}
#gate .card{width:min(420px,92vw);background:#0b1220;border:1px solid #1f2937;border-radius:14px;padding:22px;color:#dbeafe}
#gate input{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #334155;background:#0a1222;color:#e5e7eb}
#gate button{width:100%;margin-top:12px;background:#22c55e}
#gate button:hover{background:#16a34a}
#gate .msg{margin-top:10px;font-size:12px;color:#fca5a5;min-height:16px}
#app{display:none}
</style>
</head>
<body>

<section id="gate">
  <div class="card">
    <h2>🔒 Secure Access</h2>
    <p>Enter password</p>
    <input id="pw" type="password" placeholder="•••••••••••••••">
    <button id="unlockBtn">Unlock</button>
    <div class="msg" id="gateMsg"></div>
  </div>
</section>

<section id="app">
  <header>
    <h1>📊 MTurk Earnings + Alerts (Realtime)</h1>
    <p>Includes Last Month Earnings from Transfers</p>
  </header>

  <div class="controls">
    <input id="searchInput" type="text" placeholder="🔍 Filter by worker, bank, or alert...">
    <button id="exportBtn">📤 Export CSV</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Worker ID</th><th>User</th><th>Current Earnings</th><th>Last Month ($)</th>
        <th>Last Transfer ($)</th><th>Last Transfer Date</th><th>Next Transfer</th>
        <th>Bank</th><th>IP</th><th>Alert</th><th>Updated</th>
      </tr>
    </thead>
    <tbody id="dataBody"><tr><td colspan="11">Waiting for unlock...</td></tr></tbody>
  </table>

  <footer>© 2025 AB2Soft • Realtime MTurk Earnings Monitor</footer>
</section>

<script type="module">
const PASS_HASH="9b724d9df97a91d297dc1c714a3987338ebb60a2a53311d2e382411a78b9e07d"; // SHA256(AB2EARNINGS2025)
async function sha256(s){const buf=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(s));return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("")}
document.getElementById("unlockBtn").onclick=async()=>{
  const v=document.getElementById("pw").value.trim(),m=document.getElementById("gateMsg");
  if(!v){m.textContent="Password required";return}
  if(await sha256(v)===PASS_HASH){document.getElementById("gate").style.display="none";document.getElementById("app").style.display="block";boot();}
  else m.textContent="Incorrect password";
}

async function boot(){
  const {initializeApp}=await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js");
  const {getFirestore,collection,onSnapshot,orderBy,query}=await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
  const cfg={apiKey:"AIzaSyCCtBCAJvQCDj8MXb2w90qYUqRrENIIGIQ",authDomain:"mturk-monitordeep.firebaseapp.com",projectId:"mturk-monitordeep"};
  const app=initializeApp(cfg),db=getFirestore(app);
  const tbody=document.getElementById("dataBody"); let tableData=[];

  onSnapshot(
  query(collection(db, "earnings_logs"), orderBy("timestamp", "desc")),
  (snap) => {
    tableData = [];
    let html = "";

    snap.forEach(doc => {
      const d = doc.data();

      // ✅ handle Firestore timestamp OR plain string timestamp gracefully
      let ts = "";
      if (d.timestamp?.seconds) {
        // Firestore Timestamp object (serverTimestamp)
        ts = new Date(d.timestamp.seconds * 1000).toLocaleString("en-US", { timeZone: "Asia/Kolkata" });
      } else if (typeof d.timestamp === "string") {
        // already stored as string (local readable timestamp)
        ts = d.timestamp;
      }

      // ✅ mark alert rows
      const isAlert = d.alert && d.alert !== "OK" && d.alert !== "✅ OK";

      // ✅ construct table rows
      html += `
        <tr class="${isAlert ? "alert-row" : ""}">
          <td>${d.workerId || ""}</td>
          <td>${d.user || ""}</td>
          <td>${d.currentEarnings || ""}</td>
          <td>${d.lastMonthEarnings || ""}</td>
          <td>${d.lastTransferAmount || ""}</td>
          <td>${d.lastTransferDate || ""}</td>
          <td>${d.nextTransferDate || ""}</td>
          <td>${d.bankAccount || ""}</td>
          <td>${d.ip || ""}</td>
          <td>${d.alert || ""}</td>
          <td>${ts}</td>
        </tr>`;
      tableData.push(d);
    });

    // finally, render the rows
    document.querySelector("#tableBody").innerHTML = html;
  }
);


  document.getElementById("searchInput").oninput=()=> {
    const v=document.getElementById("searchInput").value.toLowerCase();
    document.querySelectorAll("#dataBody tr").forEach(r=>r.style.display=r.textContent.toLowerCase().includes(v)?"":"none");
  }

  document.getElementById("exportBtn").onclick=()=>{
    if(!tableData.length){alert("No data");return}
    const cols=["workerId","user","currentEarnings","lastMonthEarnings","lastTransferAmount","lastTransferDate","nextTransferDate","bankAccount","ip","alert"];
    const csv=[cols.join(","),...tableData.map(d=>cols.map(k=>`"${(d[k]||"").toString().replace(/"/g,'""')}"`).join(","))].join("\n");
    const a=document.createElement("a");a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));a.download="mturk_earnings.csv";a.click();
  }
}
</script>
</body>
</html>
