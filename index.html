<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>🔎 MTurk Earnings Monitor</title>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
  getFirestore, collection, query, orderBy, onSnapshot 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// --- Firebase Config ---
const firebaseConfig = {
  apiKey: "AIzaSyCCtBCAJvQCDj8MXb2w90qYUqRrENIIGIQ",
  authDomain: "mturk-monitordeep.firebaseapp.com",
  projectId: "mturk-monitordeep",
  storageBucket: "mturk-monitordeep.firebasestorage.app",
  messagingSenderId: "58392297487",
  appId: "1:58392297487:web:1365ad12110ffd0586637a"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Globals for CSV export
let tableData = [];
const fmt = n => isNaN(n) ? "" : Number(n).toFixed(2);

// --- CSV Export ---
function exportCSV() {
  if (!tableData.length) {
    alert("⚠️ No data to export yet.");
    return;
  }
  const headers = [
    "Worker ID","User","Current ($)","Last Month ($)",
    "Last Transfer ($)","Last Date","Next Transfer",
    "Bank / Gift Card","IP","Alert","Timestamp"
  ];
  const rows = tableData.map(d => [
    d.workerId || "",
    d.user || "",
    fmt(d.currentEarnings),
    fmt(d.lastMonthEarnings),
    fmt(d.lastTransferAmount),
    d.lastTransferDate || "",
    d.nextTransferDate || "",
    d.bankAccount || "",
    d.ip || "",
    d.alert || "",
    d.timestamp?.seconds
      ? new Date(d.timestamp.seconds * 1000).toLocaleString("en-US", { timeZone: "Asia/Kolkata" })
      : (typeof d.timestamp === "string" ? d.timestamp : "")
  ]);

  const csv = [headers, ...rows]
    .map(r => r.map(x => `"${String(x).replace(/"/g, '""')}"`).join(","))
    .join("\n");

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `mturk_earnings_${new Date().toISOString().slice(0,10)}.csv`;
  link.click();
}

// --- Live Snapshot ---
onSnapshot(
  query(collection(db, "earnings_logs"), orderBy("timestamp", "desc")),
  (snap) => {
    const tbody = document.querySelector("#tableBody");
    const totalElem = document.querySelector("#totalCurrentEarnings");
    if (!tbody || !totalElem) {
      console.error("❌ Missing table elements");
      return;
    }

    tableData = [];
    let html = "";
    let totalCurrent = 0;

    snap.forEach(doc => {
      const d = doc.data();

      // Convert timestamp
      let ts = "";
      if (d.timestamp?.seconds
